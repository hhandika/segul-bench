---
title: "SEGUL performance benchmark"
author: Heru Handika
output: html_document
---

This file contains all code to analyses SEGUL benchmark results. I use the R base pipe, required R version 4.1. If you are using R version <4.1, change the pipe "|>" to magrittr pipe "%>%".

```{r}
if (!require(pacman)) {
  install.packages(pacman)
}

pacman::p_load(here)
pacman::p_load(ggplot2)
pacman::p_load(readr)
pacman::p_load(dplyr)
pacman::p_load(stringr)
pacman::p_load(RColorBrewer)

source(here::here("R", "utils.R"))
```

## Load results for Handika & Esselstyn. In review

```{r}
file_path <- here("data", "data_ms_rev2.csv")
bench <- readr::read_csv(file_path) 
```

## Summarize benchmark results

```{r}
bench_results <- c("Execution_time_secs", "RAM_usage_Mb", "Percent_CPU_usage")

# Check the benchmark for each dataset contains 10 iterations
counts <- bench |>
  dplyr::count(Analyses, Datasets, Platform, OS_name, Apps)

# Check for parsing errors.
mean(counts$n)


summary_by_datasets <- bench |>
  dplyr::group_by(Analyses, Datasets, Platform, OS_name, Apps) |>
  dplyr::summarise_at(bench_results, mean)

readr::write_csv(summary_by_datasets, here("results", "mean_bench_by_dataset.csv"))
```

## Mean summary by analyses

```{r}
summary_by_analyses <- bench |>
  dplyr::group_by(Analyses, Apps) |>
  dplyr::summarise_at(bench_results, mean)

readr::write_csv(summary_by_analyses, here("results", "mean_bench_by_analyses.csv"))
```


## Generate plots using the mean of benchmark results for each datasets

The plots generated below is used for Figure 1 in the manuscript.

```{r}
summary_by_datasets |>
  dplyr::filter(OS_name == "Linux") |>
  dplyr::filter(Analyses != "Read Summary (FASTQ)") |>
  ggplot(aes(x = Execution_time_secs, y = RAM_usage_Mb)) +
    geom_point(size = 3, aes(color = Datasets, shape = Apps)) +
    facet_wrap(~ Analyses, scales = "free", ncol = 3) +
    scale_color_manual(values = accessible_palette) +
    scale_shape_manual(values = point_shapes) +
    coord_trans(x = "log") +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_classic() +
    labs(x = "Execution time (secs)", y = "Memory usage (Mb)")

.height <- 8
.width <- 10

ggsave(here("figures", "summary_fig1.png"), width = .width, height = .height, units = "in")
ggsave(here("figures", "summary_fig1.pdf"), width = .width, height = .height, units = "in")
```

## Add raw read
```{r}
apps <- c("SEGUL", "SEGUL GUI (Android)", "SEGUL GUI (iPadOS)")
analyses <- c("Alignment Concatenation (NEXUS)", "Alignment Conversion (NEXUS)", "Alignment Splitting (NEXUS)", "Alignment Summary (NEXUS)", "Sequence Removal (NEXUS)")

segul_compare <- summary_by_datasets |>
  dplyr::filter(Apps %in% apps) |>
  dplyr::filter(Analyses %in% analyses) |>
  dplyr::mutate(Analyses = str_remove_all(Analyses, "\\(NEXUS\\)"))

segul_compare |>
  ggplot(aes(x = Analyses, y = Execution_time_secs, color = Apps)) +
    geom_boxplot() +
    scale_color_brewer(palette = "Dark2") +
    scale_shape_manual(values = point_shapes) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
    theme_classic() +
    labs(y = "Execution time (secs)")

 .height <- 4
.width <- 6

ggsave(here("figures", "summary_fig2.png"), width = .width, height = .height, units = "in")
ggsave(here("figures", "summary_fig2.pdf"), width = .width, height = .height, units = "in")
```

