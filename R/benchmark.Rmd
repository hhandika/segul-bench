---
title: "SEGUL performance benchmark"
author: Heru Handika
output: html_document
---

This file contains all code to analyses SEGUL benchmark results. I use the R base pipe, required R version 4.1. If you are using R version <4.1, change the pipe "|>" to magrittr pipe "%>%".

```{r}
if (!require(pacman)) {
  install.packages(pacman)
}

pacman::p_load(here)
pacman::p_load(ggplot2)
pacman::p_load(readr)
pacman::p_load(dplyr)
pacman::p_load(stringr)
pacman::p_load(RColorBrewer)

source(here::here("R", "utils.R"))
```

## Load results for Handika & Esselstyn. In review

```{r}
file_path <- here("data", "data_ms_rev2.csv")
bench <- readr::read_csv(file_path) |>
  # ignore SEGUL GUI (Linux) Percent_CPU_usage. 
  # Not relevant for the paper and it does not seem to show the actual usage
  dplyr::mutate(Percent_CPU_usage = ifelse(Apps == "SEGUL GUI (Linux)", NA, Percent_CPU_usage)) |>
  dplyr::mutate(RAM_usage_Mb = na_if(RAM_usage_Mb, 0.0)) |>
  dplyr::mutate(Percent_CPU_usage = na_if(Percent_CPU_usage, 0.0)) |>
  dplyr::select(-Latest_bench)

readr::write_csv(bench, here("results", "benchmark.csv"), na = "")
```

## Summarize benchmark results

```{r}
bench_results <- c("Execution_time_secs", "RAM_usage_Mb", "Percent_CPU_usage") 

# Check the benchmark for each dataset contains 5 iterations
counts <- bench |>
  dplyr::count(Analyses, Datasets, Platform, OS_name, Apps)

# Check for parsing errors.
mean(counts$n)

summary_by_datasets <- bench |>
  dplyr::group_by(Analyses, Datasets, Platform, OS_name, Apps) |>
    dplyr::summarise(
    across(bench_results, ~ mean(.x, na.rm = TRUE), .names = "Mean_{.col}"),
    across(bench_results, ~ sd(.x, na.rm = TRUE), .names = "SD_{.col}"),
    )

readr::write_csv(summary_by_datasets, here("results", "mean_bench_by_dataset.csv"), na = "")
```

## Mean summary by analyses

```{r}
analyses.df <- bench |>
  # Create a analyses type column by removing input format
  dplyr::mutate(AnalysesType = str_extract(Analyses, "^[^(]+")) 

# Calculate mean and sd for each column
summary_by_analyses_type <- analyses.df |>
  dplyr::group_by(AnalysesType, Apps) |>
  dplyr::summarise(
    across(bench_results, ~ mean(.x, na.rm = TRUE), .names = "Mean_{.col}"),
    across(bench_results, ~ sd(.x, na.rm = TRUE), .names = "SD_{.col}"),
    )
  
summary_by_analyses <- analyses.df |>
  dplyr::group_by(AnalysesType, Datasets, Apps) |>
  dplyr::summarise_at(bench_results, mean)


summary_by_input_format <- analyses.df |>
  # Create a input format column by removing analyses names
  dplyr::mutate(format = str_extract(Analyses, "(?<=\\()([^)]+)(?=\\))")) |>
  dplyr::group_by(AnalysesType, format, Platform, OS_name, Apps) |>
  dplyr::summarise_at(bench_results, mean)

readr::write_csv(summary_by_analyses_type, here("results", "mean_bench_by_analyses.csv"), na = "")
```


## Generate plots using the mean of benchmark results for each datasets

Figure 1. 

```{r}
summary_by_datasets |>
  dplyr::filter(OS_name == "Linux") |>
  dplyr::filter(Analyses != "Read Summary (FASTQ)") |>
  ggplot(aes(x = Mean_Execution_time_secs, y = Mean_RAM_usage_Mb)) +
    geom_point(size = 3, aes(color = Datasets, shape = Apps)) +
    facet_wrap(~ Analyses, scales = "free", ncol = 3) +
    scale_color_manual(values = ai_2024, guide = guide_legend(nrow = 6)) +
    scale_shape_manual(values = point_shapes, guide = guide_legend(nrow = 5)) +
    coord_trans(x = "log") +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_minimal() +
    theme(legend.position = "bottom") +
    labs(x = "Mean execution time (secs)", y = "Mean RAM usage (Mb)")

.height <- 9
.width <- 10

ggsave(here("figures", "summary_fig1.png"), width = .width, height = .height, units = "in")
ggsave(here("figures", "summary_fig1.pdf"), width = .width, height = .height, units = "in")
```
## Figure 2 SEGUL GUI versus CLI performance for genome analyses

```{r}
bench |>
  dplyr::filter(OS_name == "Linux") |>
  dplyr::filter(Analyses == "Read Summary (FASTQ)") |>
  ggplot(aes(x = Execution_time_secs, y = RAM_usage_Mb)) +
    geom_point(size = 3, aes(color = Apps, shape = Apps)) +
    scale_color_manual(values = ai_2024) +
    scale_shape_manual(values = point_shapes) +
    coord_trans(x = "log") +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_minimal() +
    labs(x = "Execution time (secs)", y = "Memory usage (Mb)")

.height <- 3
.width <- 4

ggsave(here("figures", "summary_fig2.png"), width = .width, height = .height, units = "in")
ggsave(here("figures", "summary_fig2.pdf"), width = .width, height = .height, units = "in")
```


## Figure 3 Execution time comparison across different SEGUL

```{r}
apps <- c("SEGUL CLI", "SEGUL GUI (Linux)", "SEGUL GUI (Android)", "SEGUL GUI (iPadOS)")
analyses <- c("Alignment Concatenation (NEXUS)", "Alignment Conversion (NEXUS)", "Alignment Splitting (NEXUS)", "Alignment Summary (NEXUS)", "Sequence Removal (NEXUS)")
dataset <- c("Oliveros et al. 2019 (522.5 MBases, DNA)", "Shen et al. 2018 (398.8 MBases, AA)")

segul_compare <- bench |>
  dplyr::filter(Apps %in% apps) |>
  dplyr::filter(Analyses %in% analyses) |>
  dplyr::filter(Datasets %in% dataset) |>
  dplyr::mutate(Analyses = str_remove_all(Analyses, "\\(NEXUS\\)"))

segul_compare_by_analyses <- segul_compare |>
  dplyr::group_by(Analyses, Apps, Datasets) |>
  dplyr::summarise(
    mean_execution = mean(Execution_time_secs),
    sd_execution = sd(Execution_time_secs),
    lower = mean_execution - sd_execution,
    upper = mean_execution + sd_execution
  )

segul_compare_by_analyses |>
  ggplot(aes(x = Analyses, y = mean_execution, fill = Apps)) +
    geom_bar(stat = "identity", position=position_dodge()) +
    geom_errorbar(aes(ymin = lower, ymax = upper), position=position_dodge()) +
    facet_wrap(~ Datasets,  ncol = 4) +
    scale_fill_manual(values = ai_2024_4) +
    scale_x_discrete(guide = guide_axis(angle = 60)) +
    theme_minimal() +
    labs(y = "Mean execution time (secs)")


.height <- 6
.width <- 8

ggsave(here("figures", "summary_fig3.png"), width = .width, height = .height, units = "in")
ggsave(here("figures", "summary_fig3.pdf"), width = .width, height = .height, units = "in")
```

